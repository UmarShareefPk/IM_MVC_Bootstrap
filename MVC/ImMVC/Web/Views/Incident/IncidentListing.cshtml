@{
}
<link href="~/css/imListing.css" rel="stylesheet" />

<div class="row">
    <div class="col-sm-6">
        <h3 class="site-cl">Incident Listing</h3>
    </div>
    <div class="col-sm-6 text-right">
        <a href="./newIncident.html" class="btn text-white bg-success">Add New</a>
    </div>
</div>

<div class="row search-bar">
    <div class="col-sm-12">
        <span class="text-muted "> Search : </span>
        <input type="text" class="txt w-50 text-muted" placeholder="Type title or description" />
    </div>
</div>

<!-- Listing-->
<div class="row">
    <div class="col col-sm-12">
        <div class="table-responsive">
            <table class="table ">
                <thead>
                    <tr>
                        <th>Title </th>
                        <th>Description</th>
                        <th>Assigned TO</th>
                        <th>Created By</th>
                        <th>Created Date</th>
                        <th>Due Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="imListRows">
                    <tr>
                        <td><a href="./imDetail.html">First incident </a></td>
                        <td class='description text-muted' title='Lorem ipsum dolor sit amet, consectetur adipisicing elit. Cumque perferendis ipsum repudiandae nulla sequi culpa! Sint nulla fugit quidem tenetur magni corrupti expedita magnam vitae, at totam voluptatum iusto aliquam.'>  Lorem ipsum dolor... </td>
                        <td>Umar Shareef</td>
                        <td>Yasir Rasheed</td>
                        <td>12/9/2020</td>
                        <td>12/31/2020</td>
                        <td>Open</td>
                    </tr>

                </tbody>
            </table>
        </div>

        <nav aria-label="Page navigation example">
            <ul class="pagination justify-content-end">
                <li class="page-item"><a class="page-link" href="#">Previous</a></li>
                <li class="page-item"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">Next</a></li>
            </ul>
        </nav>
    </div>
</div>
@section Scripts{
    <script>
    $(document).ready(function () {
        localStorage.setItem("userlogin", JSON.stringify(@Html.Raw(ViewBag.userLogin)));
        loadIncidents();
     });

    function loadIncidents() {
        axios.defaults.headers = { 'Authorization': `Bearer @ViewBag.token` };
        const url = "https://localhost:44310/" + "api/Incidents/GetIncidentsWithPage?PageSize=8&PageNumber=1&SortBy=q&SortDirection=q&Search=";
           // "PageSize=" + parameters.PageSize + "&PageNumber=" + parameters.PageNumber
           // + "&SortBy=q&SortDirection=q&Search=" + parameters.Search;
        axios({
            method: 'GET',
            url: url
           // ,cancelToken: new axios.CancelToken(c => cancel = c)
        })
            .then((response) => {
                const data = response.data.Incidents;
                let incidents = "";
                data.forEach((incident) => {
                    incidents += "<tr>";
                    incidents += "<td><a href='#'>" + incident.Title + " </a></td>"; 
                    incidents += "   <td title='" + incident.Description + "'>  " + incident.Description.slice(0,15) +"... </td>";
                    incidents += "<td>" + incident.AssignedTo + "</td>";
                    incidents += "<td>" + incident.CreatedBy + "</td>";
                    incidents += "<td><span title=" + moment(incident.CreatedAT).format("MMMM DD YYYY, h:mm:ss a") + ">" + moment(incident.CreatedAT).fromNow() + "</span></td>";
                    incidents += "<td><span title=" + moment(incident.DueDate).format("MMMM DD YYYY, h:mm:ss a") + ">" + moment(incident.DueDate).fromNow() + "</span></td>";                    
                    incidents += "<td>" + incident.Status + "</td>";
                    incidents += "</tr>";
                })
                $("#imListRows").html(incidents);
                console.log(incidents);
            })
            .catch((err) => {
                console.log(err.message);
                const data = err.message;
                console.log(err.message);
            });    
    }

    </script>
}